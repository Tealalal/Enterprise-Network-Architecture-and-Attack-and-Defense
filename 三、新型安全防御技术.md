[toc]

# 三、新型安全防御技术

## 鲁棒加密恶意攻击流量的检测(林于翔)

### 历史发展

#### 传统恶意流量检测面临的挑战
– 基于规则的检测无法检测到零日攻击
– 由于机器学习算法的处理开销，现有的检测方法检测吞吐量较低，无法处理高速
率的网络流量
– 规避攻击可以轻松绕过使用粗粒度网络流统计信息的传统检测
– 分析每个数据包特征序列的数据包检测无法实现稳健的检测
– 对网络流量个别特征的微小变化极为敏感，在软件不断更新与流量环境不断变化
情况下，有效性降低

#### 恶意流量检测方法主要分类
– 基于误用(Misuse)的恶意流量检测
• 根据预定义的签名(Signature)来识别恶意流量，能有效过滤已知的恶意流量，但在识别
未知恶意流量方面适用性较差
– 基于异常(Anomaly)的恶意流量检测
• 依靠启发式方法来捕获恶意流量，多为基于监督学习的机器学习方法
• 基于机器学习的恶意流量检测主要步骤为数据预处理、特征选择以及检测模型训练

#### 恶意流量检测基本流程
– 收集流量（Collecting Flow Records）
– 特征提取（Feature Extraction）
– 特征表示（Feature Representation）
– 模型选择（Model Selection）
– 超参数调整（Hyperparameter Tuning）
– 优化模型（Optimized Model）

### 算法原理

#### Whisper

检测恶意流量
系统/应用运行的网络流量数据
1. 高速数据包解析，提取数据包特征
2. 轮询数据包解析器，提取频域特征
3. 自动参数选择，确定编码向量
4. 特征聚类训练，获取平均训练损失
5. 根据频域特征与聚类中心距离，检测恶意流量
待检测流量是/否为恶意流量

基于机器学习的实时鲁棒恶意流量检测
高速数据包解析
恶意流量的鲁棒精准检测以及高吞吐量的实时检测

总体框架
– 频域特征提取模块，获取特征并编码，通过频域提取序列信息
– 自动参数选择模块，计算特征提取模块的编码向量
– 统计聚类模块，用轻量级的统计聚类算法学习频域模式


![](https://s3.hedgedoc.org/demo/uploads/b7f039a3-e122-4bff-aca6-42d9ac954c65.jpg)

频域特征提取模块
– 特征提取：轮询高速数据包解析器，获取N个数据包的特征
– 包特征编码：减少特征规模，降低处理开销
– 矢量帧分割：限制数据包之间的长期依赖性
– 离散傅里叶变换：通过频域提取序列信息，减少信息损失
– 复数模计算：将频域表示的复数特征，转换为实数
– 对数变换：稳定频域特征数值，防止机器学习模型训练期间浮点溢出
– 将具有三种典型恶意流量中提取的频域特征映射到RGB空间，并观察到少量恶意流量数据包的频域特征发生了显著变化（恶意流量攻击颜色更浅）

自动参数选择模块
– 计算特征提取模块的编码向量，通过解决一个约束优化问题确定编码向量w，用来减少不同数据包特征之间的相互干扰
– 通过求解可满足性模理论（SMT）问题，逼近原问题最优解
– 减少手动选择参数的工作量
– 可以在检测阶段准确配置编码向量

统计聚类模块
– 利用统计聚类算法学习频域特征模式
– 通过训练良性流量的聚类算法，提高Whisper的鲁棒性
– 将频域特征片段的均值作为聚类算法输入
– 获取良性流量的聚类中心，计算平均训练损失
– 输出检测损失

##### 实验结果
不同流量匹配下的平均AUC和等错误概率EER 
– Whisper使用频域特征代表 了稳健的细粒度流量序列信 息，伪装成良性流量的恶意流量不会引起网络数据流统计数据的显著变化
– Whisper在不同流量匹配下具有稳定的检测精度


##### 优劣分析
优势：
– Whisper能够实现高准确率和高吞吐量的检测
– 细粒度频域特征表示数据包序列的顺序信息，确保了鲁棒检测，并防止攻击者逃避检测
– 使用轻量级聚类算法实现了高效的攻击检测
局限性：
– Whisper的编码向量的求解计算成本高

#### ACID

恶意流量分类
系统/应用运行的网络流量数据
1. 特征提取，提取统计特征
2. 自适应聚类，产生聚类中心
3. 恶意流量分类
恶意流量类别

提高恶意流量的检测准确率，最大程度降低误报率
高速数据包解析
有效载荷的特征提取成本高

总体框架
– 特征提取器模块
– 自适应聚类模块
– 分类模块

![](https://s3.hedgedoc.org/demo/uploads/d430bee3-6d9f-4007-9003-c92f915d7e6a.jpg)


特征提取器 
– 报头分析器：构建一组报头和统计特征（包括源/目标端口号、数据包到达时间、网络数据流中的数据包总数等），提供流量行为的紧凑表示
– 可选的词嵌入：通过word2vec和Text-CNN技术构建有效负载的语义表示向量

自适应聚类网络
– 采用全连接前馈神经网络，编码器将输入特征的维数降低到期望的维数，使用正弦函数作为激活函数，使网络更快学习并适应复杂的数据结构

分类模块
– 输入提取特征和聚类中心，输出该数据流所属推断类别
– 自适应聚类算法减少了同一类样本之间的差异，无论分类器具体情况如何，均可提高分类性能

##### 实验结果
合成数据集 
• 两个圆 
• 五个圆 
• 双月 
• 高斯分布点 
• 正弦和余弦 
入侵检测数据集 
• KDD Cup’99 
• ISCX-IDS 2012 
• CSECIC-IDS 2018


一般性的聚类结果 
– ACID将各类数据集中的数据点进行聚类，而不考虑形状、分布或复杂性。证明使用核网络识别聚类中心，并从分类的角度用这些中心的信息扩充特征集的关键优势

##### 优劣分析
优势：
– 最大限度地提高了恶意流量的检测准确率，最大限度地降低了误报率
– 提高了对异常值的鲁棒性和分类模型的泛化能力
– 降低模型对流量特征敏感的影响

局限性：
– 采用了word2vec和Text CNN构建有效负载的语义表示向量，增加了计算成本



## 1、C&C（ Command and Control Server ）检测/APT远控、扩散和回传的检测（SSH/SSL/TSL/ICMP/UDP/SOCKS/Proxy）（江秭昱、梁亚萌）

### （1）APT检测

> APT（高级持续性威胁）是指组织（特别是政府）或者小团体使用先进的攻击手段对特定目标进行有组织、有目标、隐蔽性强、破坏力大、持续性长的新型攻击和安全威胁。由于其背后是技术优秀、资金充足的黑客组织或集团，在攻击前准备充分，在攻击时隐蔽性强，在攻击后难以取证，APT已演化为有目的、有组织、有预谋、隐秘的群体式定向攻击。

#### APT攻击流程

![](https://s3.hedgedoc.org/demo/uploads/2cc3e017-8ced-4154-bb25-2dbbb3b2a7ea.png)


**初步侦查**：对目标进行初步研究，确定目标（系统和人员），并确定攻击方法，主要包括寻找系统中连接Internet的服务或人员信息。

**初步攻击**：攻击者成功地在目标组织内的一个或多个系统上执行恶意代码。这可能是通过社会工程学（鱼叉式邮件钓鱼攻击），也可能通过利用连接Internet的系统上存在的漏洞或者通过其他方式进行攻击。

**建立立足点**：攻击者对初步攻击中攻下的目标系统保持控制权。在初步攻击之后立即进入此阶段，通常攻击者通过安装永久性后门、将具有远程控制功能的恶意软件下载到攻下的目标系统来建立立足点。

**权限提升**：攻击者获得对系统和数据的更大的访问权限。攻击者可以通过密码哈希值的转储来提升权限（随后实现密码破解或哈希攻击）、通过键盘记录程序记录登录凭证、窃取PKI证书、利用某些应用程序拥有的特权或通过漏洞利用等方式提升权限。

**内部侦查**：攻击者探测目标组织的内部网络环境，从而更详细的了解其网络环境、关键人物的角色和责任等信息，并确定目标组织在何处存储和处理敏感信息。

**横向拓展**：攻击者使用其访问权限在受感染的环境中从一个系统拓展到另一个系统。常见的横向拓展方法包括访问共享网络、使用Windows任务计划执行程序、使用远程访问工具（如PsExec）或使用远程桌面客户端（如远程桌面协议RDP、DameWare或虚拟网络计算VNC）来访问其他系统、使用图形化用户界面与目标系统进行交互等。

**持续控制**：攻击者确保能够持续访问目标网络。为了能够持续访问和控制目标网络，攻击者通常会安装多种（或多个变种）的恶意软件或者后门，或者通过访问目标内部的虚拟专用网VPN实现远程访问功能。

**目标达成**：攻击者达成其攻击目标。攻击目标一般包括窃取知识产权、财务数据、并购信息或者个人身份信息，任务完成后，大多数攻击者不会离开目标网络，而是保持访问权限，以便可以完成新的任务。

#### APT 检测有效性的常用数据集和评价指标

**数据集**

![](https://s3.hedgedoc.org/demo/uploads/8c3b6eae-d841-49ce-8967-6e219a1b618d.png)

 以上数据集中有些存在数据较为古老等问题，在实际应用中效果并不理想。我总结了下面几种较新的数据集可供使用。

- CSE-CIC-IDS2017/2018 on AWS数据集是通信安全机构（CSE）与加拿大网络安全研究所（CIC）之间的协作项目，该项目设计了一种系统化的方法来生成数据集以分析、测试和评估入侵检测系统，将重点放在基于网络的异常检测器。通过创建用户配置文件（其中包含网络上看到的事件和行为的抽象表示），生成用于入侵检测的各种综合基准数据集。这些基准数据集将被组合起来，以生成一组不同的数据集，每个数据集都具有一组独特的功能，涵盖评估领域的一部分。最终的数据集包括七种不同的攻击场景：暴力、心血、僵尸网络、DoS、DDoS、Web攻击和从内部渗透网络。攻击基础设施包括50台机器，受害者组织有5个部门，包括420台机器和30台服务器。数据集包括捕获每台机器的网络流量和系统日志，以及使用CICFlower-V3从捕获的流量中提取的80个特征。
- honeynet数据集包含赛博实验室从2019年5月至2020年2月在蜜网实验中收集的所有数据。这个实验是基于Cowrie 蜜罐的，部署大约50个节点，分布在欧盟和美国的不同大学以及公司。由于扩展工作和目标节点的可用性，节点数在整个实验过程中都有所不同。数据集中的所有公共IP地址都使用假名，以保护目标节点的身份。数据集中的每个文件都是从该日期午夜开始的所有连接的每日汇编，用“攻击会话”进行分组。此类会话中的每个事件都包括蜜罐软件报告的所有数据
- DARPA TC：美国国防高级研究计划局（Defense Advanced Research Projects Agency, DARPA）运营了多个重量级的网络空间安全研究项目，召集了诸多美国顶级研究机构参与，可谓是集中力量办大事。其中，透明计算（Transparent Computing, TC）项目正是期望通过基于终端数据的采集与分析增强终端上系统细粒度行为的可视能力，以实现企业级网络空间APT检测、取证等关键任务。
- 数据集集合 ：Canadian Institute for Cybersecurity datasets -来自加拿大网络安全研究所整理的数据集

**评价指标**

可采用的检测性能指标包括准确率、召回率、误报率(FPR)、精度、F-分数(F-Score)、AUC 等。其中，准确率指正确预测的样本占总样本的比例，召回率指正确预测的正样本占总样本的比例，误报率表示被误分到正样本中的负样本占所有负样本的比例，精度表示正确预测的正样本占所有预测为正样本的比例，F-分数是准确率和召回率的调和值，AUC 是横坐标为 FPR，纵坐标为 TPR 所画出的 ROC 曲线下的面积，其值越大，分类效果越好。

![](https://s3.hedgedoc.org/demo/uploads/2c38255f-b89b-4e1e-ace7-300c33fab79d.png)


#### 基于系统行为的检测技术

目前已有的基于系统行为的 APT 检测技术主要分析系统调用日志，系统调用日志记录程序或命令在系统内核层面的行为活动，包括进程与文件，进程与 IP 和进程与进程之间的交互行为。一些工作基于已知的攻击事件追踪引发该攻击事件的源头，并构建攻击路径。

**数据溯源**

传统检测系统通常无法检测到APT攻击。

- 依赖恶意软件签名的检测器对利用新漏洞的攻击无效。

- 基于异常检测的系统通常分析一系列的系统调用或日志系统事件，其中大部分方法无法对长期行为进行建模。

- 由于基于异常检测的方法只能检测系统调用和事件的短序列很容易被绕过。


综上，当前针对APT攻击的检测方法很少能成功。攻击者一旦使用0-Day漏洞，防御者便无计可施；而基于系统调用和系统事件的检测方法，由于数据过于密集，这些方法难以对长时间的行为模式进行建模。因此，数据溯源（data provenance）是一种检测APT更合适的数据。

首先，基于程序系统调用日志形成主机系统依赖关系图，并进一步根据实体关系、实体行为信息等先验知识对图结点设置标签，以及标签的信任级别和密级。然后利用设定的传播规则识别异常事件。最后采用后向和前向分析分别追踪该异常事件的攻击源头和分析攻击后果。

目前主要有以下几个研究方向：

- 采用信息流追踪技术自动搜索相关的攻击路径和滤除不相关的路径，以解决依赖爆炸问题

![](https://s3.hedgedoc.org/demo/uploads/867f1093-693d-4a5f-9742-e4ccb653c01a.png)

- 不依赖任何已知的攻击事件进行APT检测
- 减少 APT 检测所带来的运行时间和存储开销
- 提出用于 APT 检测的辅助系统或工具，使检测变的更加容易和可行

**相关论文介绍**

论文汇总：[provenance-papers/ at master · tfjmp/provenance-papers · GitHub](https://github.com/tfjmp/provenance-papers/tree/master)

原文：UNICORN: Runtime Provenance-Based Detector for Advanced Persistent Threats

引言部分：

尽管数据溯源能很好地检测APT攻击，但是依旧存在挑战。当前的检测系统通常面临如下三种问题：1）静态模型无法处理长期运行的系统；2）由于APT的高级可持续的特性可以在系统中潜伏很长时间，相关的行为会被认为是正常行为，这样的攻击会影响检测模型；3）对于长期运行的情况来说内存计算的可扩展性较弱。

本文提出了一种基于溯源的APT检测系统UNICORN。UNICORN利用图概要建立一个增量的、固定大小的、纵向的图数据结构，从而实现有效的图系统计算。

本文的主要贡献如下：

1）针对APT攻击特性提出一种基于Provenance的异常检测系统。
2）引入一种新的基于概要的（sketch-based）、时间加权的（time-weighted）溯源编码，该编码非常紧凑且可处理长时间的溯源图。
3）通过模拟和真实的APT攻击来评估UNICORN，证明其可以高精度检测APT活动。
4）实现代码开源。

设计部分：

![](https://s3.hedgedoc.org/demo/uploads/1dbe4d53-9402-4499-837c-290d3e73d738.png)


1）以一个带标签的流式溯源图作为输入。该图由CamFlow（溯源搜集系统）生成，每条边是带属性的。溯源系统构建一个具有偏序关系的DAG溯源图，能实现有效的流式计算和上下文分析。

2）建立一个运行时的内存直方图。UNICORN有效构建一个流式直方图，该直方图表示系统执行的历史，如果有新边产生则实时更新直方图的计数结果。通过迭代的探索大规模图的近邻关系，发现了在上下文环境中系统实体的因果关系。该工作是UNICORN的第一步，具体来说，直方图中每个元素描述了图中唯一的一个子结构，同时考虑了子结构中的顶点与边上的异构标签，以及这些边的时间顺序。

为了适应正常系统执行过程中预期的行为变化，UNICORN定期对与最近事件没有因果关系的直方图元素的影响进行下调。这种缓慢的忘记不相关的历史事件可以在整个系统运行时有效的建模元数据。然而，这并不意味着UNICORN会忘记历史执行信息；相反，UNICORN在图中的使用信息流依赖性来保持生要的、相关的上下文信息的最新状态。APT攻击缓慢的渗透攻击目标系统，希望基于的异常检测方法最终忘记这一行为，把其当成正常的系统行为，但是APT攻击并不能破坏攻击成功的相关信息流依赖关系。

3）定期计算固定大小的概要图（graph sketch）。在纯流式环境，当UNICORN对整个溯源进行汇总时，唯一直方图元素的数量可能会任意增长。这种动态变化导致两个直方图之间的相似计算变得非常有挑战，从而使得基于直方图相似计算的建模以及检测算法变的不可行。UNICORN采用相似度保存的hash技术把直方图转换成概要图。概要图可以增量维护，也意味着UNICORN并不需要将整个溯源图都保存在内存中。另外，概要图保存了两个直方图之间的jaccard相似性，这在后续图聚类分析中特别有效。

4）将简略图聚类为模型。UNICORN可以在没有攻击知识的前提下实现APT攻击检测。与传统的聚类方法不同，UNICORN利用它的流处理能力生成一个动态演化模型。该模型通过在其运行的各个阶段对系统活动进行聚类捕获单个执行中的行为改变，但是UNICORN无法在攻击者破坏系统时动态实时修改模型。因此，它更适合APT攻击这类长期运行的攻击。

直方图生成算法：

![](https://s3.hedgedoc.org/demo/uploads/d8030d4e-4948-42d6-bc5d-0e02107c1d52.png)


评估部分：

![](https://s3.hedgedoc.org/demo/uploads/fcbc2dff-2ce4-4cc9-8809-e6a6f94082bb.png)


局限性：

- 需要定期重新训练
- 正常行为改变可能会产生误报
- 未考虑异质性行为
- 更大的实验评估(IDS数据集)

#### 基于用户行为的检测技术

相对于基于系统行为的检测技术，基于用户行为检测技术的研究工作相对较少，特别是近 5 年高质量的工作更为稀少。主要是由于用户行为事件丰富多样，事件之间的关系复杂多变，很难被刻画，这直接导致检测精度不高。但是，基于用户行为检测技术的优势在于：具有丰富的语义，能使安全分析人员容易理解攻击的本质。

**相关论文介绍**

原文：MLTracer: Malicious Logins Detection System via Graph Neural Network

引言部分：

本文提出一种恶意登录的实时检测系统——MLTracer，针对于APT横向移动攻击进行检测。它的基本流程如下：

1）提取用户登录的上下文信息；

2）利用图形神经网络（GNN）来训练和测试它们；

3）产生的登录警告根据它们的属性（即时间戳、用户和主机）被关联到恶意登录链中。

4）安全分析员监测指标的演变，并确定MLTracer是否需要重新训练。

本文主要有贡献如下：

1）提出了一种新的方法来灵活地区分关键的属性和其他属性。这种选择是基于登录属性的统计分布，从而适用于适用于各种攻击场景。

2）提出了一个通过GNN检测恶意登录和横向移动的实时系统。此外，还可以挖掘登录属性的特征并探索它们在登录操作中的相互影响关系。

3）实现了一个MLTracer的原型。评估表明MLTracer在各种横向移动和恶意登录方面明显优于现有技术。

设计部分：

![](https://s3.hedgedoc.org/demo/uploads/e84ad946-7221-4a77-be2c-aa2495e458b4.png)


1）元路径识别：MLTracer学习登录属性的关系，其形式为<源主机，上下文信息，目标主机>，因为登录操作本质上是在给定的上下文信息下从源主机到目的主机的行动。在上下文信息中保留的属性包括用户的身份（如账户和所属部门），主机的属性（如主机类型和功能），以及登录信息(如认证类型和登录型）。接下来，按照设计好的元路径，我们提取特定的属性值最后，MLTracer将metapath实例输入GNN模型。

2）图神经网络（GNN）模型：MLTracer采用了一个GNN模型来实现源主机、目的主机和上下文信息的表示（向量）。它首先使用CNN将涉及上下文信息的元路径实例表示为向量，然后输出向量。接下来，使用共同关注机制进一步改善了元路径的上下文向量、源主机和目的主机向量的表示，最后，这些向量被送入一个分类器，分类器将判断该登录是否为恶意的。

3）警报关联：MLTracer利用一套规则，将警报关联到入侵链。

4）重新训练：为了捕捉新的攻击，MLTracer根据性能的突然下降，例如，假阳性率（FPR）和召回率，触发重新训练阶段。

GNN流程图：

![](https://s3.hedgedoc.org/demo/uploads/40798ad7-0e98-41b7-a019-6b7311543d14.png)

评估部分：

![](https://s3.hedgedoc.org/demo/uploads/8eacdf9a-73c1-48fc-a5e2-2e20ebb4e025.png)


局限性：

近期，神经网络模型的成功使得它们被越来越广泛的应用于威胁检测领域。然而，神经网络模型被证明存在可被对抗学习利用的脆弱性。对抗学习利用神经网络反向传播原理，在原始样本上找到可导致模型分类错误的不易觉察微小改变，并产生这样的对抗样本。该攻击也被称为对抗攻击。此外，还有研究表明神经网络存在被投毒攻击的风险，即攻击者通过向模型的训练数据中注入恶意训练样本，刻意影响模型训练并导致模型在测试数据上的分类精度。

#### APT检测方法总结

**恶意代码检测**

（1）基于签名特征（针对已知漏洞）

了解攻击特征，提取攻击特征签名。对网络传输的数据包进行匹配后，可以准确、快速的检测到此类恶意文件的传输。

（2）基于漏洞特征（针对已知漏洞）

了解漏洞触发原理，提取漏洞触发的关键代码。一个漏洞特征可以识别所有利用该漏洞进行攻击的恶意代码。

（3）基于行为特征（针对0day漏洞）

上面两种检测方法是基于已知（Nday）攻击/漏洞的前提条件下进行针对性的防御。但攻击者利用未知（0day）漏洞开发恶意代码，则可以轻易绕过这些方法。

沙箱技术就是应对0day恶意代码提出的检测方法。它的原理就是构造一个模拟的执行环境，让可疑文件在这个模拟环境运行，通过观察文件行为来判定是否为恶意代码。

**异常流量分析**

传统的IDS相当于对流量的黑名单，对于APT攻击IDS对于流量的检测改为白名单模式

**信誉技术检测**

在面对APT攻击的时候，可以借助信誉技术进行检测。建立恶意WEBURL库，C&C地址库，僵尸网络地址库，文件MD5代码库，都是识别APT攻击的有效辅助手段。

**关联分析检测**

无论是恶意代码检测、异常流量检测、或是木马病毒告警，都只是单一安全设备的告警。APT攻击者会尝试多种路径和方法进行不断渗透入侵，单一设备的告警都是管中窥豹，无法判定是次普通攻击还是APT攻击。

我们必须建立一套覆盖传统检测技术，可以横向贯穿分析的系统。通过收集所有安全告警信息并进行关联分析，还原APT攻击的所有或者大部分入侵环节，有效区分普通攻击和APT攻击。

关联分析首先需要全面地收集安全信息（例如网络入侵检测、网络防火墙、WEB应用防火墙、内网审计系统、服务器日志、防病毒等）；其次需要安全人员具有从零散的安全告警中拼凑出APT攻击链路的方法和经验，包括识别组合攻击、长时间跨度攻击、态势分析等技能，要求比较高。

### （2）C&C检测

#### C&C攻击

​    C2, Command and Control, 命令与控制。主要是指攻击者通过与恶意软件的交互，对被害者进行控制，从而实施恶意活动的含义。从语义上来讲，C2即可用作为名词（基础设施）也可以作为动词（交互的行为），例如C2服务器（名词做定语）、攻击者进行C2。

**C&C攻击在整个攻击链中的作用**

​	任何网络入侵都可以划分为七个阶段：探查、武器化、载荷投递、漏洞利用、驻留、命令控制和恶意活动（ KILL CHAIN 模型）。电脑被入侵后，往往会在网络建立C2通道。 APT 攻击通常不以破坏为目的，基本都是窃密、监听。所以 APT 恶意软件尤其需要建立C2通道进行手动交互，而不是自动活动。这是第一个用处：指令下发。

![](https://s3.hedgedoc.org/demo/uploads/cbda6ced-a5e9-4f68-b163-d0b6f31d6142.png)

- 侦查（Reconnaissance）
- 武器化（Weaponization）
- 散布/载荷投递（Delivery）
- 恶用/漏洞利用（Exploitation）
- 设置/驻留（Installation）
- 命令与控制（Command & Control）
- 目标达成/恶意活动（Action on Objectives）


在APT攻击中，C2通信常会有以下的用处：

- 用于攻击者的指令下发
- 用于资源下发和数据上传

> 因此，C2 架构也就可以理解为，恶意软件通过什么样的方式获取资源和命令，以及通过什么样的方式将数据回传给攻击者。

**实现方式**

**1. HTTP/HTTPS、FTP**

​	HTTP/HTTPS 是最常见的C2架构。优势有以下几点：

- 应用层网络协议，成熟稳定、简单易用。
- HTTP 允许任何类型的数据对象的传输，配合GET、POST、HEAD满足大多数命令交互需求。
- 基于HTTP/HTTPS的web应用开发成熟，可在短时间开发、部署。
- Domain-IP模式，方便基础设施的迁移。
- 常见流量类型，往往不会引起防火墙和IDS注意。

​	以office 钓鱼为例，攻击者通过恶意宏或者漏洞利用，使用cscript、wscript或者powershell 从远端 HTTP 服务器拉取后门，进行安装执行。这种使用的HTTP的攻击策略，占已知披露 APT 事件的百分之九十。

​	因为HTTP是明文传输，恶意软件进行数据上传时，往往会对内容进行处理时，简单的如base64，xor；强度大一点的会使用非对称加密算法进行处理。

**2. DGA**

​	DGA 在僵尸网络中应用广泛，APT 攻击中也曾使用。

​	攻击者可以生成用作域名的伪随机字符串，根据时间或者其他种子因素的变化而变化。攻击者根据算法，可以确定正在请求的域名，进行注册、解析。这种动态变化的域名可以很好规避黑名单安全策略。加大发现攻击的难度。APT28、APT32、APT34等都曾使用过这项技术。

**3. DNS隧道技术**

​	DNS服务器根据域名的层级，进行分级查询。所谓"分级查询"，就是从根域名开始，依次查询每一级域名的NS记录，直到查到最终的IP地址。

​	DNS 隧道技术就是使用了DNS分层查询的特性。举个例子,如何使用在 `exploit.pi4net.com` 使用隧道技术：

​	DNS服务器收到查询 `exploit.pi4net.com` 的请求，并首先尝试查找域扩展名 `.com` ，然后查找 `pi4net.com` ，但无法在其数据库中找到 `exploit.pi4net.com` ,它会将请求转发给 `pi4net.com` ，并询问它是否知道这条域名的记录。这时， `pi4net.com` 可以返回查询到`exploit.pi4net.com` 的ip; 也可以返回任意字符串，这个字符串，可以用作C2指令。虽然默认空间是60个字符，但是协议本身和DNS服务器配置允许该数据空间超过这个上限。

**4. 社交平台**

​	除了协议层进行通信外， web 应用的也可以作为C2架构。目前看到有多个 Actor 通过 facebook 、 twitter 等社交平台搭建C2。这种使用社交平台的C2易于搭建，一切指令封装到加密的平台通信里面。可轻易绕过黑名单，绕过流量审计。

​	这种方式，隐蔽性高，很难从流量上发现威胁。但局限性也明显，只能传递简单指令，作资源分发，数据上传不是很好用。恶意软件使用的Twitter API，可以发布推文。资源加密后base64一下，以字符串的形式进行分发。

**5. 云盘**

​	社交平台主要进行指令下发，与之类似的攻击策略，Actor 会使用云盘进行资源下发。云盘和社交平台类似，隐蔽性强，不易发现。不同的是，一个常用于指令，一个常用于资源。

**6. TCP报文**

​	将C2指令封装到 TCP 报文中，常见于linux 服务器的恶意软件。在头部设置flag，混杂模式监听本地流量，当遇到特定帧结构的数据报文时，执行操作。

**分类**

- **传输协议层**

  使用这层协议的恶意软件，不打个人终端，主要目标是关键基础设施的服务器，尤以 linux 为甚。原因有两个：

  - 设备必须暴露在公网，传输协议层的恶意软件，都是被动监听。为了隐蔽性，往往不进行主动链接。
  - 个人终端上有更好的C2方案。

  其实不只是TCP、UDP，自数据链路层上，都可用户进行C2命令传输，处于内网渗透通信，使用 ARP 也不是不可能。但是如果网际数据传输，必须要传输层以上协议才可以。

- **应用协议层**

  ​	C2 架构比较常用的：HTTP/HTTPS、FTP、DNS、SMTP等等。

  ​	在长期的发展过程中，也延伸出许多技术。使用应用层协议进行C2通信最重要的是隐蔽性、其次才是传输效率和适用场景。

  常见的对抗技术，包括但不限于：

  - 黑名单

  - 防火墙规则

  - 内外网隔离

  - 流量审计等

  ​	应用协议层上面，稳定性、可扩展性最强的无疑是HTTP/HTTPS，FTP，可以胜任所所有的入侵场景。同时也是比较容易进行检测的。

  ​	黑名单策略可以过滤掉大部分请求，所以在一些样本中看到了 DGA 的使用。为了对抗防火墙，又有使用DNS隧道技术的样本出现。而这些技术，各有优缺，只能使用固定场景。

  - 传输文件：
  - 如果进行文件下发和数据上传，最常见的选择是http、ftp。为了增加隐蔽性，某些样本加上DGA.
  - 指令下发：
  - 指令下发，不需要太多的流量载荷。一些样本追求隐蔽性，使用DNS隧道技术。

  但是真实环境中更复杂，如果遇到内外网隔离的状况。则需要借助其他的协议。

  - 网际通信
  - 在一些隔离环境中，邮件服务器常常被列为白名单。可以使用SMTP协议，进行内外网的通讯。
  - 局域网内通信
  - 局域网内一般会有IDS进行检测，动作太大会被发现，除了常规使用的通信方法外，LPR、RAW网络打印协议也是比较好的选择。

- **应用服务层**

  ​	基于之前所讲的哪些协议，上层有许多的应用服务。比如社交平台，网盘，消息推送服务等。使用这些应用服务可以一劳永逸解决上述多数问题。

  ​	这些应用的域名和IP都被标注了白名单，并且多数都有 API 可以使用。针对特定平台，比如IOS，也发现了MDM攻击。将下发的文件、指令以及上传的数据封装在应用流量里面，既能躲避流量审计，又有不错的容错率。一件多雕，所以近几年，使用这种架构的 APT 攻击越来越多。

  ​	其实实际运用也有一定的局限，社交平台和消息服务往往都有数据限制，因此常被用于指令下发。而网盘之类的服务，自带文件属性，常被用于数据上传、资源下发。
  
#### C&C检测

##### C&C检测工具（常规）

**1.zeek**

**基本介绍：**

​    Zeek是一个被动的开源网络流量分析器。许多运营商将Zeek用作网络安全监视器（NSM），以支持对可疑或恶意活动的调查。Zeek还支持安全领域以外的各种流量分析任务，包括性能评估和故障排除。

​    新用户从Zeek获得的第一个好处是描述网络活动的大量日志。这些日志不仅包括网络上看到的每个连接的全面记录，还包括应用程序层记录。这些包括所有HTTP会话及其请求的URI，密钥标头，MIME类型和服务器响应，带回复的DNS请求，SSL证书，SMTP会话的关键内容，以及更多。默认情况下，Zeek将所有这些信息写入结构良好的制表符分隔或JSON日志文件中，这些文件适合使用外部软件进行后处理。用户还可以选择让外部数据库或SIEM产品使用，存储，处理和显示数据以进行查询。

除了日志外，Zeek还具有用于一系列分析和检测任务的内置功能，包括：

​    1.从HTTP会话中提取文件

​    2.通过与外部注册表进行接口来检测恶意软件

​    3.报告网络上可见的易受攻击的软件版本

​    4.识别流行的网络应用程序

​    5.检测SSH暴力破解

​    6.验证SSL证书链

​    在很高的层次上，Zeek在体系结构上分为两个主要组件。它的事件引擎（或核心）将传入的数据包流减少为一系列更高级别的事件。这些事件以与策略无关的方式反映了网络活动，即，它们描述了已看到的内容，而不是原因或意义是否重大。例如，线路上的每个HTTP请求都变成一个相应的 http_request事件，该事件带有所涉及的IP地址和端口，所请求的URI以及所使用的HTTP版本。但是，该事件未传达任何进一步的解释，例如该URI是否对应于已知的恶意软件站点。

![](https://s3.hedgedoc.org/demo/uploads/e2e81432-5b2d-4274-949f-64b3dfb4820a.png)

​    事件引擎组件包括多个子组件，特别是包括以下内容的包处理管道：输入源，包分析，会话分析和文件分析。输入源从网络接口摄取传入的网络流量。数据包分析处理较低级别的协议，从链路层一直开始。会话分析处理应用程序层协议，例如HTTP，FTP等。文件分析剖析了通过会话传输的文件的内容。事件引擎提供了一个插件架构，可以从Zeek核心代码库的外部添加其中的任何一个，从而可以根据需要扩展Zeek的功能。

​    与事件相关的语义是由Zeek的第二个主要组件脚本解释器派生的，该脚本解释器执行一组用Zeek的自定义脚本语言编写的事件处理程序。这些脚本可以表示站点的安全策略，例如，当监视器检测到不同类型的活动时要采取的操作。

​    更一般而言，脚本可以从输入流量中得出任何所需的属性和统计信息。实际上，Zeek的所有默认输出都来自发行版中包含的脚本。Zeek的语言带有广泛的特定于域的类型和支持功能。至关重要的是，Zeek的语言允许脚本随时间保持状态，从而使脚本能够跟踪并关联跨连接和主机边界观察到的内容的演变。Zeek脚本可以生成实时警报，还可以根据需要执行任意外部程序。人们可能会使用此功能来触发对攻击的主动响应。

**安装配置过程：**

选择Ubuntu 20.04操作系统，按照官网教程，依次输入命令：

```
echo 'deb http://download.opensuse.org/repositories/security:/zeek/xUbuntu_20.04/ /' | sudo tee /etc/apt/sources.list.d/security:zeek.list
curl -fsSL https://download.opensuse.org/repositories/security:zeek/xUbuntu_20.04/Release.key | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/security_zeek.gpg > /dev/null
sudo apt update
sudo apt install zeek
```

其中，发现有 `下列软件包有未满足的依赖关系： zeek-core : 依赖: libssl1.1 (>= 1.1.0) 但无法安装它` 的报错，通过查阅资料，直接手动下载 **libssl1.1.0** ，即输入如下指令：

```
wget http://archive.ubuntu.com/ubuntu/pool/main/o/openssl/libssl1.1_1.1.0g-2ubuntu4_amd64.deb
sudo dpkg -i libssl1.1_1.1.0g-2ubuntu4_amd64.deb
```

等待一段时间即可下载完成。

配置过程如下：

```
whereis zeekctl
export PATH=/opt/zeek/bin/:$PATH
source ~/.bashrc
zeekctl
sudo pyhton zeekctl
```

![](https://s3.hedgedoc.org/demo/uploads/42a778e2-67bc-4cc7-8746-d548c9abacf9.png)

**检测结果：**

输入如下命令，开启zeek：

```
install //初始化
start //开启检测
stop //停止检测
```

![](https://s3.hedgedoc.org/demo/uploads/18e9dbc5-504c-4190-857f-8e0aa7a3dfd7.png)

通过对如下命令对C&C流量的pcap进行检测：

```
zeek -C -r /home/zeek/桌面/botnet-capture-20110810-neris.pcap
```

检测结果输出如下：

![](https://s3.hedgedoc.org/demo/uploads/83393ced-96db-4b1a-bb3a-b37db4d61132.png)

![](https://s3.hedgedoc.org/demo/uploads/5e834ea9-2177-43af-9f92-cb33868efde6.png)

共检测出5355条异常，检出率36.9%。

**2.ClamAV**

**基本介绍**

​    ClamAV是Linux平台上领先的开源病毒扫描程序，如果你要为Linux桌面或服务器找到一个好的病毒扫描程序，这个应用程序应该是你的首选。它在命令行中运行，可以在Linux服务器和台式机上使用，并且可以很好地消除大量不同类型的恶意软件，包括恶意软件，电子邮件服务器漏洞，病毒，甚至是Windows漏洞利用程序。

值得注意的问题有：

- ClamAV是一个以命令行为中心的应用程序，它占用内存和CPU并不高。
- ClamAV可以检测各种不同的病毒，包括恶意软件，电子邮件服务器漏洞，病毒甚至Windows漏洞。
- 该软件适用于服务器和Linux桌面。
- ClamAV的电子邮件病毒扫描功能支持各种文件类型，包括流行的存档格式，可执行文件，MS Office文档，HTML文件，PDF等。
- ClamAV的病毒定义数据库每4小时更新一次，确保你始终拥有最新的漏洞利用信息。

**安装配置：**

![](https://s3.hedgedoc.org/demo/uploads/417cd1f1-fbd7-43cd-a579-2dbb7158173a.png)

**检测结果：**

![](https://s3.hedgedoc.org/demo/uploads/2a02a848-1496-4b00-8949-dedee8319b36.png)

**3.nDPI**

**基本介绍：**

​	DPI（Deep Packet Inspection）是深度包检测系统，网络的流量种类现在越来越多，有些是恶意使用，比如p2p占用带宽或恶意网络应用，由于恶意应用可能使用随机端口，因此有必要对报文进行深度分析。

nDPI有以下特点：

- 跨平台，支持windows，linux、mac等操作系统。
- 支持流量大小监控。
- 目前支持185种协议解析。
- 能够定义端口或端口范围来匹配协议。
- 能够根据字符串匹配子子协议。
- nDPI实现了线程安全。
- nDPI实现了加密流量的解析。

**安装配置：**

首先，安装以下依赖项：

```bash
sudo apt install autotools
sudo apt install libtool
sudo apt install gawk
sudo apt install gcc
sudo apt install build-essential
```

然后开始安装nDPI：

```bash
git clone https://github.com/ntop/nDPI.git
cd <nDPI source code directory>
./autogen.sh
./configure
make
cd example
```

**检测结果：**

教程参考博客（<https://www.jianshu.com/p/c03ac65dbf23>）

用root权限执行 `./ndpiReader -i ens33 -s 10` 即可开始捕获流量并检测。

![](https://s3.hedgedoc.org/demo/uploads/fe4695e2-b2b5-4406-9701-76a2dd6548c2.png)


可以通过命令 `./ndpiReader -i /dir/file.pcap` 来检测pcap文件。

![](https://s3.hedgedoc.org/demo/uploads/c6d62663-2fcc-4025-9022-618e639a4aad.png)

检出率76.5%

**4.流量数据集：**

​    CTU-13数据集。一个含有僵尸网络流量、正常流量和背景流量的且已标记的数据集。CTU-13是2011年位于捷克共和国的捷克理工大学（CTU）捕获的僵尸网络流量数据集。数据集的目标是对混杂正常流量和背景流量的真实的僵尸网络流量进行大规模捕获。CTU-13数据集包含13个不同的僵尸网络样本捕获（也叫场景）。在每个场景我们执行一个特定的恶意软件，它使用了某些协议并且执行了不同的操作。下表展示了僵尸网络场景的特征。

![img](https://img-blog.csdnimg.cn/20210518184331641.png)

​    实践每个场景捕获到一个pcap文件中，文件包含3种流量类型的数据包。对这些pcap文件进行处理来获取其他类型的信息，如NetFlows（单向网络流），WebLogs（网络日志），等等。对CTU-13数据集的第一次分析，在论文“An empirical comparison of botnet detection methods”中描述和发表。该论文用单向网络流来表示流量并且给流量赋予标签。单向网络流不应该被使用，因为我们第二篇数据集分析使用了双向网络流，效果超过了单向网络流。双向网络流与单向网络流相比有一些优点。首先，他们解决了区分客户端和服务器的问题；第二，他们包含了更多的信息。第三，他们包含更多详细的标签。使用双向网络流对数据集的第二个分析是在这里发布的。

​    CTU-13数据集的独特之处是我们手动的分析和标记了每个场景。标记过程是在网络流文件中完成的。表4展示了每个场景中标记为“背景”、“僵尸网络”、**“C&C通道”**和“正常”标签的数量关系。

​    其中有一个数据集（CTU-Malware-Capture-Botnet-42）的场景是：僵尸程序发送垃圾邮件，连接到 HTTP CC，并使用 HTTP 进行一些点击欺诈。

**5.优缺点&适用场景**


|        | 优点                                                         | 缺点                                                         | 功能                                                         |
| ------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| ClamAV | 基于文件特征对文件型的C&C通信进行检测                        | 检测精度有限：ClamAV的检测精度相对较低，可能会漏检一些新型的C&C攻击和恶意软件；ClamAV的病毒特征库更新速度相对较慢，可能会导致无法及时识别新出现的C&C攻击和恶意软件。<br />无法检测非文件型的C&C通信(如HTTP请求) | 可能可以检测文件型的C&C通信。<br />文件型的C&C通信通常是通过恶意文件中的某些特殊文件或数据来实现的，例如：<br />配置文件：恶意软件可以使用配置文件来存储C&C服务器的信息，包括IP地址、端口号、域名等，以便于与C&C服务器进行通信。这种通信方式通常是通过恶意软件读取和解析配置文件来实现的。<br />隐藏数据：恶意软件可以将C&C服务器的地址和指令等数据隐藏在文件中的某些数据或标记中，例如图片文件的像素值、音频文件的采样率、PDF文件的元数据等。这种通信方式通常是通过解析文件中的隐藏数据来实现的。<br />下载器：恶意软件可以通过下载器来下载和执行C&C服务器上的恶意软件。下载器通常会被嵌入到其他文件中，例如Word文档、PDF文件、Flash动画等，以便于向受害者传播恶意软件 |
| zeek   | 灵活性：Zeek可以通过添加自定义的脚本和插件来扩展其检测功能，用户可以根据自己的需要，添加特定的规则和检测策略，从而更好地发现和防御C&C攻击。<br />协议分析：Zeek通过对网络流量进行协议分析，提取网络通信中的各种协议和数据，包括HTTP、DNS、SMTP等。对于C&C攻击，Zeek会分析恶意软件与C&C服务器之间的通信协议和数据，从而识别恶意行为。<br />行为分析：Zeek可以通过行为分析来识别C&C攻击，例如检测主机上的不寻常行为、异常流量、频繁的DNS请求、未知的网络连接等。这些行为特征可以帮助Zeek发现隐藏的恶意软件和C&C通信。 | 学习成本高：Zeek作为一款高级网络安全监测工具，需要用户具备一定的网络安全知识和技能，否则可能无法充分利用其功能和优势。<br />系统资源占用高：Zeek需要占用较高的系统资源，包括CPU、内存和磁盘空间等，对于资源有限的系统可能会造成一定的影响。<br />网络流量处理量大：Zeek需要处理大量的网络流量数据，对于大型网络来说，可能会需要更多的硬件支持和数据存储。<br />检出率：36.9% | Zeek是一种网络安全监测工具，其可以被配置为检测网络中的许多不同类型的活动，包括C&C通信。Zeek通过实时监测网络流量数据，分析网络流量中的数据包并提取有关通信的信息，例如使用哪些协议、使用哪些端口等。Zeek还可以通过对流量数据进行深度分析，检测出一些常见的C&C通信模式，例如域名生成算法（DGA）和快速切换通信（Fast Flux）等。 |
| nDPI   | 精度高：DPI技术可以深入分析网络流量的内容，可以识别C&C通信中的命令和数据，准确判断是否存在恶意行为<br />实时性强：DPI技术可以对网络流量进行实时分析，及时发现恶意流量和C&C通信，有利于防范网络攻击。<br />可扩展性好：DPI技术可以通过更新识别规则和算法来扩展检测能力，应对新型的网络攻击和恶意软件。 | 处理量大：DPI技术需要对网络流量进行深入分析，处理的数据量相对较大，需要更多的计算资源和存储空间。<br />隐私问题：DPI技术需要深入分析网络流量的内容，可能会涉及到用户的隐私问题，需要采取相应的保护措施。<br />可能被绕过：攻击者可以采用加密、混淆等技术来绕过DPI检测，从而达到欺骗和攻击的目的。<br />检出率：76.5% | DPI（Deep Packet Inspection）是深度包检测系统，网络的流量种类现在越来越多，有些是恶意使用，比如p2p占用带宽或恶意网络应用，由于恶意应用可能使用随机端口，因此有必要对报文进行深度分析。 |

##### 针对未知&加密的C&C攻击的检测方法

**1.利用AI检测隐蔽的C2通信**


**主要思想：**

- 应用AI的难点
    - 辨识度低
    - 数据量小
    - 特征维度小
    - 随机性强
- 问题分析（C2通信与普通通信的差异）
    - 网络数据包：数据包载荷
    - 网络会话流：数据包出现的顺序反映出代码执行的顺序
    - **通信信道：**
        ![](https://s3.hedgedoc.org/demo/uploads/3b0aa118-799d-4be9-a9fd-7bc33b437a61.png)

        - 应用数据载荷主要传输方向上的差异
        - 服务器被有效访问频次的差异
        - 用户数量的差异
- 解决思路
    以通信信道为观察对象，TLS通信信道：{目的IP，目的端口}
- 验证假设
    - 数据载荷传输方向上的差异
    - 通信频次上的差异
    - 用户数的差异
    ![](https://s3.hedgedoc.org/demo/uploads/8c5745cf-3888-4f2e-bfd3-bf62643d723c.png)
- TLS通信信道基础特征
    ![](https://s3.hedgedoc.org/demo/uploads/77b3053e-3e34-4609-b499-6f4b90f077cb.png)
- 数据集选择
    - 良性样本：来自内网样本
    - 恶意样本来源
        - Malware Traffic (MT)
        - Stratosphere IPS (SIPS)
        - Canadian Institute for Cybersecurity (CIC)
        （其中MT和SIPS：普通的恶意TLS流样本；CIC：深度协议伪装的恶意TLS流样本）
- 实验结果
    ![](https://s3.hedgedoc.org/demo/uploads/cbe51194-5cc4-4202-861f-e70c8d04d324.png)


## 主机深度智能检测技术（深度脱壳检测、抗沙箱反分析、内存解密反混淆）（梁超越）

### 抗沙箱反分析

### 1、对抗沙箱检测的主要思路
环境探测: 通过环境特征判断是否是沙箱?
1、计算特征:动态沙箱需要构建虚拟环境以处理大规模样本(驱动、设备ID、CPU指令、特定服务)
2、异常特征:沙箱需要全面监测数据，以实施检测判断(调试、指令插桩、SSDT劫持）
3、高靶向性行为触发:仅针对特定目标触发行为

图灵测试: 从用户行为特征判断是否目标用户?
1、每个检测环境无法进行人为操作的部分:鼠标等设备操作、网络访问、历史日志.

其他检测对抗方法
1、DecpLocker:AI黑箱模型中嵌入检测对抗逻辑
2、Stalling Code 迟滞代码(高强度千扰性数学运算、APIFlood)
3、Fileless 无文件攻击脚本(Powershell)



#### 以模糊测试确定指令仿真缺陷

Proteus(RAID’ 18): 探测android虚拟沙箱环境的过程：
（1）生成测试程序
（2）提取真实CPU和沙箱模拟器指令记录
（3）识别指令执行差异:寄存器、内存和异常信息
（4）排除非确定类型指令的干扰
![](https://s3.hedgedoc.org/demo/uploads/6396b150-6086-4ecf-a5c2-9847e212f763.png)

![](https://s3.hedgedoc.org/demo/uploads/f04b6148-a88a-4620-8972-3082e49e654f.png)




#### 通过黑盒测试自动抽取杀毒软件沙箱环境特征

（1）标注恶意样本:每个样本分配特定ID
（2）恶意样本加壳混淆:避免被静态检测
（3）将沙箱环境特征查询请求编码为执行逻辑，生成最终样本
（4）杀毒软件扫描样本，得到查杀结果
（5）依据查杀结果获取环境特征

![](https://s3.hedgedoc.org/demo/uploads/542312cb-a13b-4634-b0c5-0661d1e013d7.png)

![](https://s3.hedgedoc.org/demo/uploads/86245159-205c-4282-a23f-f246bd6c41c5.png)


#### 基于系统使用“磨损”痕迹，探测运行环境
（1）通过从真实用户设备和公开可用恶意软件分析服务收集使用磨损痕迹
![](https://s3.hedgedoc.org/demo/uploads/fdad2aca-1cbf-4d28-9f1b-f78e865f6065.png)


（2）基于使用年限和磨损程度构建统计分类模型（收集的数据包括:系统信息类、磁盘信息、网络数据信息、注册表信息、浏览器痕迹）
![](https://s3.hedgedoc.org/demo/uploads/57aa0566-fd3d-407f-9085-7e4c6a013a08.png)
![](https://s3.hedgedoc.org/demo/uploads/2b76b9bf-9a52-4e71-9efe-78143f3e7ef1.png)


（3）基于决策树探测运行环境是否为检测系统
![](https://s3.hedgedoc.org/demo/uploads/7b028876-a9ef-437a-b024-437964de0627.png)

#### DeepLocker

（1）采集外部环境信息
收集目标物理环境、软件环境、用户行为、地理位置等属性信息

（2）构建深度学习模型决策模型
训练用于目标识别的多层神经网络模型，模型捆绑到恶意代码中用于目标环境判断

（3）智能决策
基于AI算法检测运行环境是否为目标环境;在非目标环境执行无害行为，在目标环境执行恶意行为

![](https://s3.hedgedoc.org/demo/uploads/fd329df9-640f-4c1e-9aa9-7282d4f127db.png)

### 2、沙箱反对抗的主要思路

（1）高透明沙箱
Bare-metal沙箱:基于物理主机构建
（2）规避行为检测
以Bare-meta沙箱为参照进行比对检测: BareCloud
Stalling Code 迟滞代码检测
（3）多路径执行
强制执行特定路径:X-force执行环境主动构造:GoldenEye


#### BareBox

（1）裸机硬件上进行恶意软件分析

（2）无需重启的系统快速恢复
    内存数据备份恢复机制:内核实现Meta-OS，将物理内存重新分3个区，第一个用于Targetos，第二个用于Target OS的备份，第三个用于Meta-os以支持内存数据的恢复
    基于RAM disk模拟磁盘驱动器，保障分析过程实际硬盘不被修改

（3）软件监控和数据获取
系统驱动:通过SSDT的监控记录恶意代码系统调用层面的行为
![](https://s3.hedgedoc.org/demo/uploads/8d6b7ea6-ecdf-42bd-acfa-4353c4ae4c9c.png)

![](https://s3.hedgedoc.org/demo/uploads/bed7cd6f-4cd8-460e-a07d-fba54b34557f.png)

![](https://s3.hedgedoc.org/demo/uploads/6b22557f-fac9-42e9-94f9-e06d5ce331c9.png)



#### BareCloud

BareCloud检测恶意样本的“规避检测”行为的过程：
（1）不同环境下获取恶意样本的行为数据
Virtualization、Emulation.Hypervisor、Bare-metal环境下获取恶意样本的行为数据

（2）检测其“规避检测”的行为
比较样本在不同环境下行为的差异性

（3）将各个不同平台的行为结果按照统一规范进行表示

![](https://s3.hedgedoc.org/demo/uploads/7b951df1-24ad-40bf-b8fb-6fb9d290481d.png)

![](https://s3.hedgedoc.org/demo/uploads/87f3cffb-bc6f-4621-804f-7580c04e430a.png)

![](https://s3.hedgedoc.org/demo/uploads/38f120b6-5b3c-4353-a803-1590051d4b77.png)


#### 迟滞代码(Stalling Code)检测

（1）动态插桩并构建动态控制流图
- 基本块开头
- Call和ret指令
（2）别活跃循环
（3）识别迟滞循环
- 启发式规则:最内层活跃循环
- 缓解性能损失方法:
被动方法:减少监控点
主动方法:主动终止迟滞代码

![](https://s3.hedgedoc.org/demo/uploads/5d4a7234-b2fe-4755-b037-1f64e70109ee.png)

![](https://s3.hedgedoc.org/demo/uploads/39629ba1-7908-4a4a-87fc-5df1eca12068.png)

#### 强制执行特定路径: X-force

（1）强制改写“污点”分支条件
- 改写造成程序状态异常
内存异常:按需分配内存
输入缺失:实时提供随机值

- 特殊情况处理
Switch跳转表，循环和递归
栈和堆覆写保护
外部库函数，多线程改为串行

（2）多路径遍历策略
路径覆盖优先“间接跳转”覆盖优先

![](https://s3.hedgedoc.org/demo/uploads/67fe5b59-6ae5-4ea3-8ccd-ee7184cee568.png)

![](https://s3.hedgedoc.org/demo/uploads/a21b582d-4597-40c7-84b1-de986691f7a8.png)

#### 通过渐进式预执行选择沙箱环境: GoldenEye

（1）环境敏感样本筛选
- 污点分析

（2）基于环境特征动态构建多个执行环境
- 穷举环境特征所有可能值语言:中文、英文等

（3）沙箱环境选取:污点辅助的并发预执行
- 渐进式分析:每次选取一个基本块多个环境同时执行
- 启发式优化策略：包含创建进程、线程等敏感操作；没有调用Exit等退出函数

![](https://s3.hedgedoc.org/demo/uploads/cdc9ecd3-f159-43a6-a839-93810e46119a.png)

![](https://s3.hedgedoc.org/demo/uploads/37939f30-42c0-425c-a441-f859e924b83b.png)

#### PHP恶意软件的多路径分析:MalMax

![](https://s3.hedgedoc.org/demo/uploads/5cc236bb-9130-43a8-af48-2cc00da9ccd8.png)



## 未知新型攻击流量的AI智能检测技术（梁超越）

###  使用分层学习防御对抗性机器学习攻击

​	目前，机器学习是自动检测恶意流量的重要方式，以确保计算机网络和组织免受网络安全攻击。最近，研究者对于对抗性机器学习领域（例如生成式对抗网络——GAN）的兴趣越来越大，该领域探讨了对抗者应当如何破坏机器学习模型，从而导致错误的分类输出。

​	虽然大部分对抗性机器学习研究都集中在计算机视觉领域（例如通过微小的像素扰动欺骗分类模型），但是这一风险存在于所有机器学习的应用中，包括针对恶意流量检测模型的攻击。通过精心构造对抗性实例，可以对网络流量分类模型进行对抗性攻击，使得已知的攻击类型被模型错误地归为良性样本，从而绕过检测。为了防御这种攻击，可以采用一种基于分层学习的防御策略。目标是减少对抗性实例在预期攻击的参数空间约束下可以利用的攻击面，从而抵御对抗性攻击。而且在没有受到攻击时，也应当达到与原始模型一致的分类精度。



### 1、对抗性机器学习

​	机器学习系统容易受到精心设计的攻击，这些攻击的目的是产生任意或特定的错误分类，因为输入值的细微扰动会导致机器学习分类器的输出产生显著差异。机器学习的性能可以通过、精确度、召回率或F1-Score（精确度和召回率的调和平均值）进行评估。



对抗性攻击可以分为**中毒攻击**和**推理攻击**：

​	**中毒攻击**影响训练阶段，旨在通过用新样本扩充训练数据集或修改现有样本来影响分类。

​	**推理攻击**旨在通过利用模型对其训练数据的敏感性来影响分类，典型的策略包括梯度下降和生成对抗网络(GANS)。该类攻击也被称为逃避攻击，攻击者的目标可能是将恶意样本错误分类为良性样本。



对抗性攻击主要分为三种类型：**白盒**、**黑盒**和**灰盒**。

​	白盒攻击假定对目标模型有完整的了解，这一点较难实现。

​	在黑盒模型下，攻击者可能会选择性地通过利用“oracle”攻击策略来获取知识，使用多个查询来逐步修改恶意样本，直到它被错误分类。还有一种创建代理模型的攻击方式，有研究者指出，影响一个模型的对抗性示例通常会影响另一个模型，即使模型具有不同的体系结构或在不同的训练集上进行训练也是如此。对于可转移的对抗性示例，两个模型都经过训练来执行相同的分类任务即可。对手可能会训练自己的代理模型，针对代理模型制作对抗性示例，然后在对目标模型知之甚少的情况下将它们转移到目标。

​	灰盒攻击假定对目标模型有部分了解。例如，对手可能对模型使用的特征有一些了解。确实这很有可能。所有基于机器学习的IDS 都必须分析原始网络流量。基于机器学习的IDS 系统可能会在网络上接受训练，具有足够领域知识的熟练对手可以估计可能使用哪些功能以及它们如何影响性能。




### 2、数据集

​	加拿大网络安全研究所IDS 2017 数据集 (CICIDS2017)  是现代 IDS 数据集的常用范例，在研究人员中越来越受欢迎。该数据集包含5天在多系统基础设施中捕获的数据包，有**良性流量样本**以及 14 种常见攻击：包括**暴力破解 FTP、暴力破解SSH、拒绝服务(DoS)、心脏滴血（Heartbleed）、Web 攻击（SQL注入、XSS）、渗透、僵尸网络和分布式拒绝服务 (DDoS)**。这些数据以一系列数据包捕获 (PCAP) 文件的形式提供，以及 CSV 格式的数据集（使用 CICFlowMeter 工具导出）

​	每个流的典型特征包括：流持续时间、数据包统计、流字节/秒、流数据包/秒、IAT 统计、标志、标头长度、下载/上传比率、批量统计、子流统计、Init Win 字节、活动数据包转发、活动统计数据和空闲统计数据等。

​	在 CICIDS2017 数据集的改进标记中派生了 25 个可能的类，因为之前标记的一些攻击没有成功执行（例如，没有导致数据传输），这些攻击标签附有“已尝试”标签。实际使用数据集时，会采用过采样和欠采样技术来有效地平衡数据集，最终产生了 7500 个样本（每类 300 个样本）作为机器学习的数据集。

![](https://s3.hedgedoc.org/demo/uploads/3a79bb56-426b-4670-b433-a17f6f985ad8.png)




### 3、分类模型

​	使用 scikit-learn MLP（多层感知器）模型训练多类分类器，将其称为目标模型。该模型由三个全连接层组成，并经过最多 300 次迭代训练。通过对重采样数据集进行预处理并将其拆分为训练样本和测试样本（70%训练样本和30%测试样本）。使用 Adam 优化器来训练目标模型，以生成训练有素的模型。目标模型的准确率为 91%，召回率为 93%，F1-score为 89%。



​	除了目标模型之外，同时为相同的入侵检测任务训练一个代理神经网络模型，使用替代框架 (Keras) 来构建。由于已知这两个模型相似并且使用免费数据集的一部分进行训练，该方法可被认为是灰盒攻击。与目标模型一样，代理模型由三个全连接层和一个softmax 激活层组成。显示该模型达到了与我们的目标模型相当的精度（准确率为 91%，召回率为 93%，F1-score为 90%）。

![](https://s3.hedgedoc.org/demo/uploads/c9333d7d-48b1-4e34-a2ea-7f27c6caa263.png)






​	下图显示了(a) 目标模型和 (b) 替代模型的混淆矩阵，用于评估每个单独类别的分类性能并评估错误分类情况，可以发现目标模型和替代模型的表现效果基本相当。

![img](https://ars.els-cdn.com/content/image/1-s2.0-S2214212622002423-gr1_lrg.jpg)

​													(a)目标模型 (Scikit-learn)，(b) 代理模型 (Keras) 的混淆矩阵









### 4、对抗性攻击模型

​	从对抗的角度来看，我们的任务是让目标模型进行错误分类，通常称为*逃避攻击*。对抗性攻击模型有许多种，例如Broyden–Fletcher–Goldfarb–Shanno 算法 (L-BFGS)、快速梯度符号法 (FGSM)、基于雅可比的显着图攻击 (JSMA)、Deepfool 和 Carlini &瓦格纳攻击 (C&W)。这里使用基于雅可比矩阵的显着图攻击 (JSMA)为的替代模型生成对抗性示例，然后针对目标模型进行测试。

​	从结果来看，90.25% 的攻击能够逃避检测。

![](https://s3.hedgedoc.org/demo/uploads/0baf92b4-9adb-408f-968f-837bd45b708e.png)


![img](https://ars.els-cdn.com/content/image/1-s2.0-S2214212622002423-gr2_lrg.jpg)

​	非靶向JSMA ($\theta$=0.05和$\gamma$=0.02) 针对 (a) 目标模型 (Scikit-learn)，(b) 代理模型 (Keras)攻击后的混淆矩阵

### 5、分层学习防御模型

​	成功攻陷网络流量分类模型后，需要探索防御策略，以提高分类器针对对抗性攻击的鲁棒性。以前的方法经常使用一组精选的对抗性示例来重新训练分类器，但是该方法不可扩展，只能在发现攻击后提供追溯防御。

​	为了解决这一问题，可以通过对攻击类型分层来重构可能发生错误分类的攻击面，使得错误分类标签所需的扰动量变得比原始分类更大，主要思路是在层次结构的任何级别将可能的输出状态数量从 25 种减少到大约 2-5 种状态。

​	本次实验采取了7种不同的分层方案进行实验：K-Means; Ward; Average; Complete; Single; Researcher Defined; and Dataset。



![img](https://ars.els-cdn.com/content/image/1-s2.0-S2214212622002423-gr7_lrg.jpg)

​                                                           （a）原始数据集和（b）研究者分类



![img](https://ars.els-cdn.com/content/image/1-s2.0-S2214212622002423-gr8_lrg.jpg)

​                                                                               K-means聚类结果



![img](https://ars.els-cdn.com/content/image/1-s2.0-S2214212622002423-gr9_lrg.jpg)

​                                                    (a) Ward，(b) Average，(c) Complete，和 (d) Single

### 6、层次分类结果

​	从结果来看，对抗性示例的分类平均提高了 84.85%：从 0.33 增加到 0.61，增加了 0.28 这种改进可以从橙色和棕色水平线之间的差异中看出。

无论是否存在对抗性学习攻击，分层防御模型都能实现良好的稳健性。我们注意到，所有层次结构都提高了在对抗条件下通过 F1-Score 衡量的稳健性。此外，当不存在对抗性流量时，分层方法还可以提高 F1-Score。

![img](https://ars.els-cdn.com/content/image/1-s2.0-S2214212622002423-gr10_lrg.jpg)

下图显示了(a) 粗糙层和 (b) 精细层的混淆矩阵，与原始模型性能相比，错误分类的情况有所减少。

![img](https://ars.els-cdn.com/content/image/1-s2.0-S2214212622002423-gr11_lrg.jpg)


## 其他防御技术的调研
### 1.蜜罐技术
#### （1）简介
蜜罐是一种安全威胁的主动防御技术，它通过模拟一个或多个易受攻击的主机或服务来吸引攻击者，捕获攻击流量与样本，发现网络威胁、提取威胁特征，蜜罐的价值在于被探测、攻陷。蜜罐吸引攻击者，从而延缓、检测、组织攻击者的攻击。在攻击的过程中，有经验的攻击者也可能识别出目标是一个蜜罐。为此，为更好的吸引攻击者，蜜罐也需要提供强悍的攻击诱骗能力。
依据蜜罐诱骗能力或交互能力的高低，蜜罐可分为低交互蜜罐与高交互蜜罐。低交互蜜罐主要通过模拟一些服务，为攻击者提供简单的交互，而高交互蜜罐模拟了整个系统与服务，它们大多是真实的系统或设备，存在配置难，难以部署的问题。相反低交互蜜罐配置简单，可以较容易的完成部署，但是受限于交互能力，无法捕获高价值的攻击。在何种场景使用何种蜜罐，就需要部署人员进行认真思考。
通常情况下，蜜罐的主要作用是捕获攻击者信息（溯源反制）或捕捉攻击方式（方便判断攻击态势，分析攻击方式、手段，捕捉0day漏洞等）。蜜罐对于分析攻击者的攻击路径，攻击手段，分析系统的脆弱点以及攻击溯源都有非常大的作用。一些商业级蜜罐还集成了获取攻击者真实身份的功能。
#### （2）开源工具
目前有几款开源工具：
（i）Hfish:
github地址：[https://github.com/hacklcx/HFish](https://github.com/hacklcx/HFish)
官网地址：[https://hfish.io/#/](https://hfish.io/#/)
HFish是一款社区型免费蜜罐，侧重企业安全场景，从内网失陷检测、外网威胁感知、威胁情报生产三个场景出发，为用户提供可独立操作且实用的功能，通过安全、敏捷、可靠的中低交互蜜罐增加用户在失陷感知和威胁情报领域的能力。
HFish的主要优点是：
- 提供了Linux一键部署，部署快捷
- 有控制端，可以通过控制端对蜜罐进行统一管理。
- 支持多种蜜罐环境。

（ii）Ehoney
github地址：[https://github.com/seccome/Ehoney](https://github.com/seccome/Ehoney)
Golang编写，作用类似于Hfish，蜜罐环境也很全面
（iii）Honeyd
github地址：[https://github.com/DataSoft/Honeyd](https://github.com/DataSoft/Honeyd)
Honeyd是一款开源的蜜罐软件，可以在网络上创建多个虚拟主机，模拟不同类型的服务器和操作系统，从而诱导和分析攻击者的行为。
Honeyd的主要特点是：
- 灵活性：Honeyd可以配置虚拟主机的服务、端口、应答、脚本等，以模拟各种网络环境和场景。
- 可扩展性：Honeyd可以在一个主机上创建多达65536个虚拟主机，也可以在多个主机上部署Honeyd，形成一个大型的蜜罐网络。
- 兼容性：Honeyd可以运行在Linux、FreeBSD、OpenBSD、Solaris等多种平台上，也可以与其他蜜罐工具如Snort、Nmap等集成。
缺点就是Honeyd是一个非常初始的系统，如果希望发挥强大的作用需要自行配置系统和工具，相比较其他两个工具而言配置复杂，不够方便
#### （3）实际测试
安装部署HFish
![](https://s3.hedgedoc.org/demo/uploads/c3aa95da-2a8a-488a-95cd-00a4db5d7b2a.png)
尝试使用虚拟机攻击，可以看到在攻击来源中显示了所有访问蜜罐的IP地址。
![](https://s3.hedgedoc.org/demo/uploads/0bbd74d1-a129-4721-b0d4-794a4bdf89de.png)
在尝试攻击9092端口时，我们尝试登入系统。以下是蜜罐记录的我们尝试的用户名和密码。
![](https://s3.hedgedoc.org/demo/uploads/2962cc36-303f-4666-80e0-9845bbcbf3ed.png)
使用nmap进行扫描，以下是蜜罐记录的扫描行为。
![](https://s3.hedgedoc.org/demo/uploads/ca515f72-d0dd-4db5-9b76-e506bb8148ea.png)
蜜罐可以记录每一次攻击的请求记录。
![](https://s3.hedgedoc.org/demo/uploads/ec82634e-a29f-41c2-a589-86c9db03d592.png)
#### （4）优缺点
蜜罐技术的主要优点是可以发现未知的网络威胁、提取威胁特征，增强安全能力
主要缺点是：
- 可能被攻击者识破或破坏
- 牵涉到隐私权问题
- 增加管理成本和风险
- 一旦蜜罐的隔离没有做好，可能会使蜜罐成为攻击者攻击内网的跳板。

#### （5）反蜜罐
现有的反蜜罐措施主要针对低交互蜜罐，因为它本身具备一些指纹信息比如软件硬编码或网络层指纹信息。高交互蜜罐很好地模拟了系统和服务，更接近真实的生产环境，所以目前没有很好的方法识别高交互蜜罐。
目前蜜罐的识别主要是基于蜜罐的指纹信息。
- 硬编码特征是低交互蜜罐在开发的过程中，引入了一些固定字段即硬编码特征，导致在响应数据包中会暴露蜜罐系统
- 蜜罐对协议分片的处理。比如《基于数据包分片的工控蜜罐识别方法》论文中提出可以利用工控协议中蜜罐与真实机器对数据包分片的不同处理方式来识别。比如作者发现在Modbus协议解析中，若Conpot蜜罐接收少于7字节，就会丢弃数据包，所以作者提出可以将modbus协议包分片，使得第一部分小于7字节并接收响应来判断是否处于Conpot蜜罐中。
- 协议返回数据。比如Hfish 蜜罐中实现了Telnet协议，默认监听在23端口。模拟的该协议默认无需验证，并且对各个命令的结果都做了响应的模板来做应答。在命令为空或者直接回车换行时，会响应default模板，该模板内容为test。我们可以通过这些特征进行验证。
![](https://s3.hedgedoc.org/demo/uploads/84140ba3-49fb-4439-8430-dbcf107d2ef9.png)

还有很多其他的协议特征
![](https://s3.hedgedoc.org/demo/uploads/e5088a66-46f1-4e72-b580-50e101b8aa07.png)
- Web的响应特征。部分开源蜜罐提供了web服务，这些web服务中常常会带有一些明显的特征，可以根据这些特征来检测蜜罐。如特定的js文件、build_hash或者版本号等。比如Hfish中默认8080端口实现了一个WordPress登录页面，页面中由一个名为x.js的javascript文件用来记录尝试爆破的登录名密码。直接通过判断wordpress登录页是否存在x.js文件就可判断是否为蜜罐。

![](https://s3.hedgedoc.org/demo/uploads/e27e1f2d-bfd9-4bbf-9504-65fc7db94ca1.png)
一些反蜜罐插件，如 AntiHoneypot-Chrome-simple插件就是利用蜜罐的特征js文件来判断是否是蜜罐。
![](https://s3.hedgedoc.org/demo/uploads/a3a579cd-da40-441f-9efd-befbdf602311.png)
其他蜜罐的Web特征如下图
![](https://s3.hedgedoc.org/demo/uploads/aa248cbf-6b3e-4fee-8cee-be765e706ce7.png)
- jsonp识别。jsonp跨域漏洞是蜜罐中非常重要的溯源技术。蜜罐通过jsonp跨域漏洞和XSS漏洞，可以有效获取攻击者在浏览器上的cookie、用户名等信息。有一些工具通过收集和匹配jsonp的特征来判断是否是蜜罐。
- 攻击者亦可利用时间延迟也可识别蜜罐,因为低交互蜜罐作为软件运行在操作系统上层，会对资源造成消耗，增大响应时延。
- 也有一些反蜜罐措施是在进入蜜罐系统后，采用系统调用的方式，调用内部某些功能，依据执行的结果判断是否是蜜罐。
- 使用蜜罐自身的漏洞反制蜜罐也是可行的。相比较于检测蜜罐来说，这种方法更主动，但难度更大。
总之，已有的反蜜罐技术种类繁多，通过识别蜜罐网络层面、硬件层面或者软件层面的各种指纹特征，实现蜜罐的检测。该类技术原理简单但在识别低交互蜜罐方面却常常简单高效。
反蜜罐工具：
- [Heimdallr](https://github.com/graynjo/Heimdallr)：是一款致力于被动嗅探浏览器流量，提示高危资产指纹和蜜罐特征，并进行拦截告警的谷歌插件，还可以用于对浏览器特征追踪（evercookie、webRTC、Canvas画布等）的对抗.
-  [AntiHoneypot-Chrome-simple插件](https://github.com/iiiusky/AntiHoneypot-Chrome-simple):AntiHoneypot-Chrome-simple插件通过简单的预置的蜜罐特征来检测蜜罐，它在插件的background.js中定义了一组规则，分别是文件名和内容的对应。不过该插件会在访问过程中请求两次正常的js文件，有很明显的特征，很容易被识别。同时该插件主要识别特征文件名，可以修改特征文件以绕过检查。
![](https://s3.hedgedoc.org/demo/uploads/6a224b66-3ece-4e9c-a664-a7e4aa660585.png)

- antiHoneypot插件：主要原理是修改DOM，在网页前端注入js的形式来抵御多种浏览器指纹识别手段，并检测敏感函数调用。主要缺陷是注入的js代码依赖于window.postMessage，可以通过覆盖掉劫持。同时该插件在检测Jsonp和XSS时，只需要在URL里面的参数中加一个chrome-extension://就可以绕过检测
- [anti-honeypot插件](https://github.com/cnrstar/anti-honeypot):首先它判断当前请求发起的域是否在白名单中，如果是则正常，如果不是则匹配发起域名是否与请求域名相同，相同则正常，否则匹配目标的path中是否包含jsonp或者callback这样的关键字，如果有则告警。

### 2.云计算安全技术
#### （1）KubeArmor
官网：[Runtime protection for Kubernetes (kubearmor.io)](https://kubearmor.io/)
KubeArmor 使用 eBPF 和 Linux 安全模块 （LSM） 提供基于策略的系统 ，以限制云原生工作负载在运行时的任何不需要的恶意行为。该工具可通过规则配置，对容器指定资源与行为（如进程执行、文件访问、网络操作和资源利用率）进行监控和拦截。
KubeArmor通过修改配置文件来设置规则。
比如我们禁止带有“group-1”标签的容器中执行“/bin/sleep”，为此，我们在 selector -> matchLabels 中定义 ‘group-1’ 标签，在 process -> matchPaths 中定义特定路径（’/bin/sleep’）。
```
apiVersion: security.kubearmor.com/v1  
kind: KubeArmorPolicy  
metadata:  
  name: ksp-group-1-proc-path-block  
  namespace: multiubuntu  
spec:  
  selector:  
    matchLabels:  
      group: group-1  
  process:  
    matchPaths:  
    - path: /bin/sleep  
  action:  
    Block
```
在底层，KubeArmor主要基于Linux的AppArmor、SeLinux、BPF-LSM提供安全服务。
#### （2）安全容器
安全容器的技术本质就是隔离。gVisor和Kata Container是比较具有代表性的实现方式，目前学术界也在探索基于Intel SGX的安全容器。
gVisor是在用户态和内核态之间抽象出一层，封装成API，有点像沙箱，以此实现隔离。Kata Container采用了轻量级的虚拟机隔离，与传统的VM比较类似，但是它实现了无缝集成当前的Kubernetes加Docker架构。
- gVisor是用Golang编写的用户态内核，或者说是沙箱技术，它主要实现了大部分的system call。它运行在应用程序和内核之间，为它们提供隔离。gVisor被使用在Google云计算平台的App Engine、Cloud Functions和Cloud ML中。gVisor运行时，是由多个沙箱组成，这些沙箱进程共同覆盖了一个或多个容器。通过拦截从应用程序到主机内核的所有系统调用，并使用用户空间中的Sentry处理它们，gVisor充当guest kernel的角色，且无需通过虚拟化硬件转换，可以将它看做vmm与guest kernel的集合，或是seccomp的增强版。但是gVisor因为会频繁终端调用system call，会造成很大的开销。

![](https://s3.hedgedoc.org/demo/uploads/6318b7a9-567f-494d-b759-2b573734d483.png)


- Kata Container的Container Runtime是用hypervisor ，然后用hardware virtualization实现，如同虚拟机。所以每一个像这样的Kata Container的Pod，都是一个轻量级虚拟机，它拥有完整的Linux内核。所以Kata Container与VM一样能提供强隔离性，但由于它的优化和性能设计，同时也拥有与容器相媲美的敏捷性。Kata Container在主机上有一个kata-runtime来启动和配置新容器。对于Kata VM中的每个容器，主机上都有相应的Kata Shim。 Kata Shim接收来自客户端的API请求（例如Docker或kubectl），并通过VSock将请求转发给Kata VM内的代理。 Kata容器进一步优化以减少VM启动时间。 使用QEMU的轻量级版本NEMU，删除了约80％的设备和包。 VM-Templating创建运行Kata VM实例的克隆，并与其他新创建的Kata VM共享，这样减少了启动时间和Guest VM内存消耗。 Hotplug功能允许VM使用最少的资源（例如CPU、内存、virtio块）进行引导，并在以后请求时添加其他资源。

![](https://s3.hedgedoc.org/demo/uploads/38004b04-adfd-4b0c-93e3-c1f3997e9386.png)

#### （3）云安全开源工具
根据[https://segmentfault.com/a/1190000041424520](https://segmentfault.com/a/1190000041424520)总结。有以下云安全开源工具
| 项目 | 厂商 | 链接 | 类型 |
| :--------: | :--------:| :------------| :--------:|
| clair | Quay |https://github.com/quay/clair|镜像扫描|
| trivy | Aqua |https://github.com/aquasecurity/trivy|漏洞扫描|
| kube-hunter|Aqua|https://github.com/aquasecurity/kube-hunter/|漏洞扫描|
| kube-bench | Aqua |https://github.com/aquasecurity/kube-bench|CIS 安全基线|
| starboard|Aqua|https://github.com/aquasecurity/starboard|Dashboard|
|tracee|Aqua|https://github.com/aquasecurity/tracee|基于 eBPF 的系统事件追踪|
|anchore-engine|anchore|https://github.com/anchore/anchore-engine|漏洞扫描|
|kyverno|kyverno.io|https://github.com/kyverno/kyverno|Kubernetes 策略与审计|
|GateKeeper|OPA (sysdig)|https://github.com/open-policy-agent/gatekeeper|Kubernetes 策略与审计|
|falco|falcosecurity(sysdig)|https://github.com/falcosecurity/falco|基于内核模块的系统事件追踪、警告|
|terrascan|accurics.com|https://github.com/tenable/terrascan|通用的 IaS 配置扫描|
|Kubei|portshift|https://github.com/openclarity/kubeclarity|镜像扫描|
|Polaris|Fairwinds|https://github.com/FairwindsOps/polaris|配置扫描与策略|
|kubesec|controlplaneio|https://github.com/controlplaneio/kubesec|Kubernetes 配置扫描|
|KubeEye|KubeSphere|https://github.com/kubesphere/kubeeye|基于策略的 Kubernetes 集群配置扫描|
|kube-linter|Stackrox(RedHat)|https://github.com/stackrox/kube-linter|Kubernetes 配置扫描|

上表中，我们列举出了来自各个安全厂商的主要开源项目。从上面的表格中我们可以看出,目前开源安全软件集中在四大类别：
- 1.  镜像漏洞扫描
- 2. 合规、基线扫描
- 3. Kubernetes 安全策略、配置管理
- 4. 威胁检测

我们尝试使用Trivy扫描有漏洞的docker镜像，扫描结果如下。

![](https://s3.hedgedoc.org/demo/uploads/78b4de28-3a17-4f3e-80e2-fae40084987d.png)

#### （4）NeuVector
NeuVector是一个开源的云安全平台。
NeuVector有以下特点
- 统一部署：NeuVector集成了诸多安全功能，不需要用户去思考如何配置各种安全组件。
- 可视化：NeuVector 的可视化面板能有效的帮助管理员分析当前系统存在的风险。汇总显示了系统中的安全事件，主机/容器漏洞，Ingress/Egress 流量等。还支持 pdf、csv 导出功能，方便用户生成报告和分析。
- 拥有资源管控、事件通知、集群管理等特点。

对比：
- 镜像扫描：镜像漏洞扫描工具中，Clair，Trivy，Anchore-engine 垄断绝大部分开源市场。根据测试，trivy工具的配置非常简单，基本是开箱即用，而NeuVector有一定的配置难度。同时，Trivy等工具不但支持 Alpine, RHEL, CentOS, Ubuntu 等系统软件包的漏洞扫描，还支持基于开发语言的依赖包漏洞扫描，如 Go, Python, PHP, Node.js Java, .Net 等，同时也会自动将CVE漏洞拉入数据库中。
- 合规审计：（没有测试）
- 内核事件审计：目前NeuVector没有相关文档。而现有的工具都是采用非常成熟的基于eBPF的技术。

### 3.供应链安全技术
软件供应链是指在整个软件生命周期中涉及应用程序或以任何方式在其开发中发挥作用的任何事和物。根据软件生命周期中一系列环节与传统供应链的相似性，由传统供应链扩展而来，包括第三方代码/组件引入、应用开发测试、渠道分发、交付下载使用等。当今企业软件中最大的风险并不是由内部软件开发团队编写的不安全代码。当今软件代码库大部分的组件、库和其他开源代码存在的缺陷才是威胁的重要来源。为了保证安全，需要对软件的供应链安全进行审计。
#### 工具
(1)Contrast Security
Contrast Security以其交互式应用程序安全测试(IAST)技术而闻名，该技术通过运行在应用程序服务器上的代理检测应用程序中的漏洞，Contrast Security提供软件组合分析(SCA))功能，作为其开放平台完整测试计划的一部分，该平台还进行动态应用程序安全测试(DAST)、静态应用程序安全测试(SAST)，AWS Lambda基础设施的运行时应用程序扫描保护(RASP)和无服务器安全检查。
该工具不仅可以生成软件物料清单 (SBOM)，还可以通过可视化应用程序架构、代码树和消息流信息来对构成应用程序的各种成分的缺陷实现场景化，以帮助进行威胁建模补救。开源治理嵌入在现代开发工作流程和工具中。
(2)Shiftleft
ShiftLeft在这个选项领域相对较新，旨在适应具有前瞻性思维的DevOps团队的开发工作流程。其核心价值在于将软件组合分析(SCA)和静态应用程序安全测试(SAST)整合到一个扫描行为中，当开发人员提出拉取请求时完成该扫描。该技术使用该公司称为代码属性图(CPG)的技术来绘制自定义代码、开源库、SDK和API之间的依赖关系和数据流，不仅可以找出整个应用程序的缺陷，还包括其开源组件，但也是逻辑应用程序的弱点。供应链缺陷通过使用插入到软件物料清单 (SBOM)中的“可达性”指数对攻击的敏感性进行优先级排序，该指数根据组件在应用程序中的使用方式将其置于组件可攻击性的场景中。
(3)Snyk
Snyk是一套云原生、以开发人员为中心的工具，专为DevSecOps和云原生开发商店而构建。它以其SCA和容器安全扫描功能而闻名，它还提供SAST和API漏洞测试。Snyk可以直接集成到开发工具、工作流程和自动化流水线中，帮助团队在代码、依赖项、容器和基础架构即代码中查找、优先处理和修复安全漏洞。Snyk支持多种语言和框架，包括Java、Node.js、Python、Ruby、Go等。
(4)Sonatype Nexus
Sonatype Nexus平台的核心是其创建详细的软件物料清单 (SBOM)和策略管理的能力。策略不仅可以应用于代码中的内容，还可以用于管理周围基础设施的安全性和配置，作为用于开发和部署应用程序的代码和容器。
Sonatype Nexus还提供存储库管理，为所有组件、二进制文件和构建工件提供单一事实来源。Nexus的组件历史可视化和Sonatype的客户服务也被分析师称为其最大优势。Sonatype建立了Sonatype Lift功能，在代码审查期间提供对开发人员友好的代码质量分析。
(5)Synopsys Black Duck
Synopsys公司的Black Duck SCA工具执行四种类型的分析(依赖性、代码打印、二进制和片段)，以跟踪和管理组织软件中使用的组件。它用于提供SCA以及DAST、SAST、渗透测试、模糊测试和一系列其他测试功能的开放平台模型是一个关键的创新。
(6)DependencyTrack 
DependencyTrack 是一个开源的软件供应链组件分析平台，使组织能够识别和减少使用第三方和开源组件的风险。它通过利用软件物料清单（SBOM，Software Bill-of-Materials）的功能采取了独特方法。这种方法提供了传统软件组成分析（SCA）解决方案无法实现的功能。Dependency-Track 监视产品组合中每个应用程序所有版本的组件使用情况，以便主动识别整个组织的风险。该平台采用API优先设计，非常适合在持续集成和持续交付（CI/CD）环境中使用。同时，DependencyTrack支持Docker方式部署，可以快速搭建使用环境。
#### 实际使用
这里以DependencyTrack为例
使用docker部署DependencyTrack，访问网页并登录。
使用pom.xml生成bom.xml，然后将bom.xml提交到DependencyTracker网页端，即可查看检测情况。
![](https://s3.hedgedoc.org/demo/uploads/0c17eeb4-9abf-4511-b846-7ae0f1af9320.png)


### 4.沙箱技术

#### 定义
沙箱是指一种隔离环境，用于隔离不受信任的应用程序或代码，以防止它们对系统造成损害。以下是一些需要使用沙箱的原因：安全性：沙箱可以提供一种安全环境，防止恶意软件和病毒感染系统。它们可以限制应用程序的访问权限，例如访问文件系统、网络和硬件资源等。软件测试：沙箱可以用于软件测试，以测试应用程序在特定环境下的行为，例如在不同的操作系统、浏览器或设备上。防止干扰：沙箱可以防止应用程序之间的干扰，例如在同一系统上运行的多个应用程序。隐私保护：沙箱可以保护用户隐私，防止应用程序访问敏感数据。总之，沙箱提供了一种安全、可控的环境，可以在其中运行不受信任的应用程序或代码，从而保护系统和数据的安全。
#### 沙箱的技术原理
沙箱的技术原理是通过隔离和限制应用程序的访问权限来创建一个受控的环境。以下是一些常见的沙箱技术原理：
- 虚拟化：虚拟化技术可以创建一个虚拟的操作系统环境，其中应用程序可以运行。这个虚拟环境与主机系统完全隔离，因此应用程序无法影响主机系统。这种技术可以用于创建虚拟机或容器，从而提供一种隔离的环境。
- 沙盒：沙盒是一种用于隔离应用程序的技术，它在应用程序运行时创建一个独立的、封闭的环境。这种环境限制了应用程序的访问权限，例如对文件系统、网络和其他资源的访问。如果应用程序试图访问限制的资源，沙盒会拒绝该访问，并记录该事件以供审计。
- 代码分析：代码分析是一种技术，可以分析应用程序的代码，并检测潜在的安全漏洞。这种技术可以用于检测恶意代码，并将其隔离在一个受控环境中。总之，沙箱的技术原理是通过隔离和限制应用程序的访问权限来创建一个受控的环境，从而保护系统和数据的安全。不同的沙箱技术使用不同的原理来实现这个目标，包括虚拟化、沙盒和代码分析等。

#### 开源沙箱工具
以下是一些常见的开源沙箱工具：
- Cuckoo Sandbox：这是一个基于Python的开源沙箱，可以用于分析恶意代码。它可以运行在Windows、Linux和Mac OS X操作系统上，并提供了多种分析方法。
- Firejail：这是一个轻量级的沙箱工具，可以用于隔离应用程序和进程。它可以限制应用程序的访问权限，例如对文件系统、网络和其他资源的访问。
- Docker：Docker是一种开源容器平台，可以用于创建、部署和运行容器化的应用程序。Docker容器可以提供一种隔离的环境，其中应用程序可以运行，而不会影响主机系统。
- VirtualBox：这是一个开源的虚拟化平台，可以用于创建虚拟机。虚拟机可以提供一种完全隔离的环境，其中应用程序可以运行，而不会影响主机系统。
- Sandboxie：这是一个免费的沙箱工具，可以用于隔离应用程序和进程。它可以限制应用程序的访问权限，例如对文件系统、网络和其他资源的访问。总之，这些开源沙箱工具都可以用于隔离应用程序和进程，并提供一种安全、可控的环境，从而保护系统和数据的安全。选择哪种沙箱工具取决于具体的需求和场景。


